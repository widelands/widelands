name: Launchpad Mirror
on:
  push:
#    branches:
#      - master
jobs:
  mirror:
    name: Copying master branch to Launchpad
    runs-on: ubuntu-latest
    steps:
    - name: Setting up bazaar
      run: |
        sudo apt-get update
        sudo apt-get install bzr
        mkdir ~/.ssh || true
        echo "${{ secrets.LP_SSH }}" > ~/.ssh/id_rsa
        chmod 400 ~/.ssh/id_rsa
        echo "${{ secrets.LP_HOST }}" > ~/.ssh/known_hosts
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        bzr whoami "Wideland's Bunnybot <bunnybot@widelands.org>"
        bzr launchpad-login "nordfriese" # nocom widelandsofficial
    - name: Checkout master
      run: |
        cd ~
        git clone --depth=1 https://github.com/widelands/widelands.git wl_master
    - name: Checkout trunk
      run: |
        cd ~
        bzr branch lp:widelands wl_trunk
    - name: Cleaning tree
      run: |
        cd ~/wl_trunk
        for file in $(ls -A)
        do
          if ! [ "$file" == ".bzr" ]
          then
            rm -r "$file"
          fi
        done
    - name: Copying files
      run: |
        cd ~/wl_master
        for file in $(ls -A)
        do
          if ! [ "$file" == ".git" ]
          then
            cp -r $file ~/wl_trunk/$file
          fi
        done
        cd ~/wl_trunk
        mv .gitignore .bzrignore
    - name: Committing and pushing changes
      run: |
        cd ~/wl_trunk
        bzr remove
        bzr add
        commit_message=$(git show --oneline $GITHUB_SHA | grep -m 1 "")
        bzr commit --strict -m "$GITHUB_ACTOR: $commit_message"
        bzr push lp:~widelands-dev/widelands/test-github-mirror # :parent
