name: build - codecheck
on:
  workflow_call:

jobs:
  codecheck:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 1
    - name: Test
      run: |
        ./cmake/codecheck/run_tests.py
    - name: Check
      run: |
        set -o pipefail # to keep return value
        #
        {
        # for all c++ source files excluding /third_party/
        ./cmake/codecheck/CodeCheck.py src/*.cc src/*.h src/[^t]*/
        ./utils/build_deps.py
        } | tee codecheck.out
        # exit code of CodeCheck.py and build_deps.py is also 0 if failures detected
      timeout-minutes: 2
    - name: Report
      run: |
        if [ -s codecheck.out ] ; then
          echo "You have codecheck warnings (see above). Please fix."
          exit 1
        elif ls -d src/*/ |
          grep --fixed-strings --line-regexp --invert-match \
            -e src/third_party/ $(ls -d src/[^t]*/ | sed ' s/^/-e /')
        then  # checked the pattern from above step, it excluded too much
          echo 'Only /third_party/ should be excluded, but above is skipped as well.'
          echo 'Update the pattern in this workflow'
          exit 4
        else
          echo "Codecheck is clear :)"
          exit 0
        fi
