###################################
#   Widelands.org                 #
#                                 #
#   Appveyor build configuration  #
###################################

image: Visual Studio 2019

init:
  - cmd: "IF \"%PLATFORM%\" == \"x86\" (set BITS=32) ELSE (set BITS=64)"
  - cmd: "set VCPKG_ROOT=C:\\tools\\vcpkg"
  - cmd: "set VCPKG_DEFAULT_BINARY_CACHE=%APPVEYOR_BUILD_FOLDER%\\vcpkg_bincache"
  - cmd: "set VCPKG_TARGET_TRIPLET=%PLATFORM%-windows-static"
  
cache: 
  - '%VCPKG_DEFAULT_BINARY_CACHE%' -> appveyor.yml

install:
  # Installing various utilities
  # As of 2019-12-06 we have to install 'chocolatey-core.extension' beforehand.
  # Otherwise installing 'InnoSetup' will fail.
  - choco install -y chocolatey-core.extension
  - choco install -y InnoSetup
  - cmd: "set PATH=C:\\Program Files (x86)\\Inno Setup 5;%PATH%"
  # Install required libs
  - cmd: "vcpkg install --disable-metrics --triplet=%VCPKG_TARGET_TRIPLET% boost gettext libpng icu glbinding sdl2 sdl2-ttf sdl2-mixer[libvorbis,libflac,mpg123] sdl2-image[libjpeg-turbo,tiff] graphite2 harfbuzz opusfile libwebp"
  # Setup build environment (https://www.appveyor.com/docs/lang/cpp/)
  - call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars%BITS%.bat"

shallow_clone: false

branches:
  only:
    - master
    - msvc_ci_action

build_script:
  - cmd: cd %APPVEYOR_BUILD_FOLDER%
  - cmd: md build
  - cmd: cd build
  # detect revision
  - cmd: python %APPVEYOR_BUILD_FOLDER%\utils\detect_revision.py > %APPVEYOR_BUILD_FOLDER%\WL_RELEASE
  - cmd: set /p WIDELANDS_VERSION_STRING=<%APPVEYOR_BUILD_FOLDER%\WL_RELEASE
  - cmd: "cmake -G \"NMake Makefiles\" -DVCPKG_TARGET_TRIPLET=%VCPKG_TARGET_TRIPLET% -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\\scripts\\buildsystems\\vcpkg.cmake -DCMAKE_BUILD_TYPE=%CONFIGURATION% -DOPTION_BUILD_WEBSITE_TOOLS=OFF -DOPTION_BUILD_TRANSLATIONS=ON -DOPTION_BUILD_TESTS=ON -DOPTION_ASAN=OFF -DOPTION_BUILD_CODECHECK=OFF -DOPTION_BUILD_WINSTATIC=ON -DOPTION_USE_GLBINDING=ON %APPVEYOR_BUILD_FOLDER%"
  - cmd: nmake
on_success:
  - cmd: "IF \"%CONFIGURATION%\" == \"Release\" (strip -sv %APPVEYOR_BUILD_FOLDER%\\build\\src\\widelands.exe)"
  - cmd: ISCC /q /o%APPVEYOR_BUILD_FOLDER% /fWidelands-%CONFIGURATION%-%PLATFORM%-%WIDELANDS_VERSION_STRING% c:\projects\widelands\utils\win32\innosetup\Widelands.iss
  - appveyor PushArtifact %APPVEYOR_BUILD_FOLDER%\Widelands-%CONFIGURATION%-%PLATFORM%-%WIDELANDS_VERSION_STRING%.exe

artifacts:
  - path: Widelands-$(CONFIGURATION)-$(PLATFORM)-$(WIDELANDS_VERSION_STRING).exe
    name: Widelands Setup

platform:
  - x64
  - x86

configuration:
  - Release
  - Debug
