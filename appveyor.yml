###################################
#   Widelands.org                 #
#                                 #
#   Appveyor build configuration  #
###################################

init:
  - cmd: "IF \"%PLATFORM%\" == \"x86\" (set MINGWPATH=C:\\msys64\\mingw32\\bin& set MINGWSUFFIX=i686& set MINGWINCLUDE=C:\\msys64\\mingw32\\include) ELSE (set MINGWPATH=C:\\msys64\\mingw64\\bin& set MINGWSUFFIX=x86_64& set MINGWINCLUDE=C:\\msys64\\mingw64\\include)"

install:
  # Installing various utilities
  # As of 2019-12-06 we have to install 'chocolatey-core.extension' beforehand.
  # Otherwise installing 'InnoSetup' will fail.
  - choco install -y chocolatey-core.extension
  - choco install -y InnoSetup
  - cmd: "set PATH=%MINGWPATH%;C:\\msys64\\usr\\bin;C:\\Program Files (x86)\\Inno Setup 5;%PATH%"
  - cmd: "set CC=%MINGWPATH%\\gcc.exe"
  - cmd: "set CXX=%MINGWPATH%\\g++.exe"
  # Update mirrors
  - cmd: "bash --login -c \"pacman --noconfirm -U http://repo.msys2.org/msys/x86_64/pacman-5.2.1-6-x86_64.pkg.tar.xz\""
  - cmd: "bash --login -c \"pacman --noconfirm -Sy zstd pacman pacman-mirrors\""
  # deleting broken repo from mirrorlist
  # - cmd: "bash --login -c \"sed -i 7d C:/msys64/etc/pacman.d/mirrorlist.msys\""
  # - cmd: "bash --login -c \"sed -i 7d C:/msys64/etc/pacman.d/mirrorlist.mingw32\""
  # - cmd: "bash --login -c \"sed -i 7d C:/msys64/etc/pacman.d/mirrorlist.mingw64\""
  # Update msys2 system (twice, first run does system packages)
  - cmd: "bash --login -c \"pacman -Suuyy --noconfirm\""
  # deleting broken repo from mirrorlist again
  # - cmd: "bash --login -c \"sed -i 7d C:/msys64/etc/pacman.d/mirrorlist.msys\""
  # - cmd: "bash --login -c \"sed -i 7d C:/msys64/etc/pacman.d/mirrorlist.mingw32\""
  # - cmd: "bash --login -c \"sed -i 7d C:/msys64/etc/pacman.d/mirrorlist.mingw64\""
  - cmd: "bash --login -c \"pacman -Suuyy --nodeps --noconfirm\""
  # Installed required libs
  - cmd: "bash --login -c \"pacman --noconfirm -S mingw-w64-%MINGWSUFFIX%-ninja mingw-w64-%MINGWSUFFIX%-boost mingw-w64-%MINGWSUFFIX%-SDL2_ttf mingw-w64-%MINGWSUFFIX%-SDL2_mixer mingw-w64-%MINGWSUFFIX%-SDL2_image mingw-w64-%MINGWSUFFIX%-glew\""

shallow_clone: true

branches:
  only:
    - master
    - static_link

build_script:
  # copy modified libintl.h to solve an issue with boost
  - cmd: patch %MINGWINCLUDE%\libintl.h %APPVEYOR_BUILD_FOLDER%\utils\appveyor\libintl.patch
  - cmd: mv C:/msys64/mingw64/lib/libglew32.dll.a C:/msys64/mingw64/lib/_libglew32.dll.a
  - cmd: mv C:/msys64/mingw32/lib/libglew32.dll.a C:/msys64/mingw32/lib/_libglew32.dll.a
  - cmd: cd %APPVEYOR_BUILD_FOLDER%
  - cmd: md build
  - cmd: cd build
  - cmd: echo %APPVEYOR_BUILD_VERSION%_%CONFIGURATION%_%PLATFORM% > %APPVEYOR_BUILD_FOLDER%\WL_RELEASE
  - cmd: "IF \"%PLATFORM%\" == \"x86\" (cmake -G \"Ninja\" -DBoost_NO_BOOST_CMAKE=ON -DCMAKE_BUILD_TYPE=%CONFIGURATION% -DOPTION_USE_GLBINDING=OFF -DOPTION_GLEW_STATIC=ON -DOPTION_BUILD_WEBSITE_TOOLS=OFF -DOPTION_ASAN=OFF -DOPTION_BUILD_CODECHECK=OFF -DCMAKE_JOB_POOLS=\"linking=1\" -DCMAKE_JOB_POOL_LINK=linking -DPNG_LIBRARY_RELEASE=\"C:/msys64/mingw32/lib/libpng.a\" -DSDL2_IMAGE_LIBRARY=\"C:/msys64/mingw32/lib/libSDL2_image.a\" -DZLIB_LIBRARY_RELEASE=\"C:/msys64/mingw32/lib/libz.a\" -DSDL2_TTF_LIBRARY=\"C:/msys64/mingw32/lib/libSDL2_ttf.a\" -DSDL2_MIXER_LIBRARY=\"C:/msys64/mingw32/lib/libSDL2_mixer.a\" -DSDL2MAIN_LIBRARY=\"C:/msys64/mingw32/lib/libSDL2main.a\" -DSDL2_LIBRARY=\"C:/msys64/mingw32/lib/libSDL2.a\" -DICU_UC_LIBRARY_RELEASE=\"C:/msys64/mingw32/lib/libicuuc.a\" -DICU_DT_LIBRARY_RELEASE=\"C:/msys64/mingw32/lib/libicudt.a\" -DIntl_LIBRARY=\"C:/msys64/mingw32/lib/libintl.a\" %APPVEYOR_BUILD_FOLDER%) ELSE (cmake -G \"Ninja\" -DBoost_NO_BOOST_CMAKE=ON -DCMAKE_BUILD_TYPE=%CONFIGURATION% -DOPTION_USE_GLBINDING=OFF -DOPTION_GLEW_STATIC=ON -DOPTION_BUILD_CODECHECK=OFF -DOPTION_BUILD_WEBSITE_TOOLS=OFF -DOPTION_ASAN=OFF -DCMAKE_JOB_POOLS=\"linking=1\" -DCMAKE_JOB_POOL_LINK=linking -DPNG_LIBRARY_RELEASE=\"C:/msys64/mingw64/lib/libpng.a\" -DSDL2_IMAGE_LIBRARY=\"C:/msys64/mingw64/lib/libSDL2_image.a\" -DZLIB_LIBRARY_RELEASE=\"C:/msys64/mingw64/lib/libz.a\" -DSDL2_TTF_LIBRARY=\"C:/msys64/mingw64/lib/libSDL2_ttf.a\" -DSDL2_MIXER_LIBRARY=\"C:/msys64/mingw64/lib/libSDL2_mixer.a\" -DSDL2MAIN_LIBRARY=\"C:/msys64/mingw64/lib/libSDL2main.a\" -DSDL2_LIBRARY=\"C:/msys64/mingw64/lib/libSDL2.a\" -DICU_UC_LIBRARY_RELEASE=\"C:/msys64/mingw64/lib/libicuuc.a\" -DICU_DT_LIBRARY_RELEASE=\"C:/msys64/mingw64/lib/libicudt.a\" -DIntl_LIBRARY=\"C:/msys64/mingw64/lib/libintl.a\" %APPVEYOR_BUILD_FOLDER%)"
  - cmd: "cmake --build ."
on_success:
  - cmd: strip -sv %APPVEYOR_BUILD_FOLDER%\build\src\widelands.exe
  - cmd: ISCC /q /o%APPVEYOR_BUILD_FOLDER% /fWidelands-%APPVEYOR_BUILD_VERSION%-%CONFIGURATION%-%PLATFORM% c:\projects\widelands\utils\win32\innosetup\Widelands.iss
  - appveyor PushArtifact %APPVEYOR_BUILD_FOLDER%\Widelands-%APPVEYOR_BUILD_VERSION%-%CONFIGURATION%-%PLATFORM%.exe

artifacts:
  - path: Widelands-$(APPVEYOR_BUILD_VERSION)-$(CONFIGURATION)-$(PLATFORM).exe
    name: Widelands Setup

platform:
  - x64
  - x86

configuration:
  - Release
  # - Debug
